name: Build OpenWrt Packages

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-ipk:
    name: Build IPK for OpenWrt
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - arch: mipsel_24kc
            sdk: openwrt-23.05.2-ramips-mt7621-sdk-linux-x86_64
            sdk_url: https://downloads.openwrt.org/releases/23.05.2/targets/ramips/mt7621/openwrt-23.05.2-ramips-mt7621-sdk-linux-x86_64.tar.xz
          - arch: aarch64_cortex-a53
            sdk: openwrt-23.05.2-bcm27xx-bcm2710-sdk-linux-x86_64
            sdk_url: https://downloads.openwrt.org/releases/23.05.2/targets/bcm27xx/bcm2710/openwrt-23.05.2-bcm27xx-bcm2710-sdk-linux-x86_64.tar.xz
          - arch: x86_64
            sdk: openwrt-23.05.2-x86-64-sdk-linux-x86_64
            sdk_url: https://downloads.openwrt.org/releases/23.05.2/targets/x86/64/openwrt-23.05.2-x86-64-sdk-linux-x86_64.tar.xz

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 unzip wget \
          python3-distutils python3-setuptools python3-dev rsync subversion \
          swig time xsltproc zlib1g-dev

      - name: Download OpenWrt SDK
        run: |
          wget ${{ matrix.target.sdk_url }}
          tar xf ${{ matrix.target.sdk }}.tar.xz
          mv ${{ matrix.target.sdk }} openwrt-sdk

      - name: Copy package to SDK
        run: |
          mkdir -p openwrt-sdk/package/uaforge
          cp -r src/ Cargo.toml Makefile LICENSE files/ openwrt-sdk/package/uaforge/

      - name: Configure feeds
        working-directory: openwrt-sdk
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Build package
        working-directory: openwrt-sdk
        run: |
          make defconfig
          make package/uaforge/compile V=s

      - name: Find IPK files
        id: find_ipk
        working-directory: openwrt-sdk
        run: |
          IPK_PATH=$(find bin/packages -name "uaforge*.ipk" | head -n 1)
          echo "ipk_path=$IPK_PATH" >> $GITHUB_OUTPUT
          echo "Found IPK: $IPK_PATH"

      - name: Upload IPK artifact
        uses: actions/upload-artifact@v4
        with:
          name: uaforge-ipk-${{ matrix.target.arch }}
          path: openwrt-sdk/${{ steps.find_ipk.outputs.ipk_path }}
          if-no-files-found: error

  release:
    name: Create Release
    needs: build-ipk
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*.ipk
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
